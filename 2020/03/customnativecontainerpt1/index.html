<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Custom Native Container [Part 1]: The Basics - Yet another gamedev blog</title><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name=renderer content="webkit"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta name=theme-color content="#000000"><meta http-equiv=window-target content="_top"><meta name=description content="This article will show how to create a basic custom native container in Unity DOTS for use with the job system."><meta name=generator content="Hugo 0.64.0 with theme pure"><title>Custom Native Container [Part 1]: The Basics - Yet another gamedev blog</title><link rel=stylesheet href=https://dotsplayground.com/css/style.css><meta property="og:title" content="Custom Native Container [Part 1]: The Basics"><meta property="og:description" content="This article will show how to create a basic custom native container in Unity DOTS for use with the job system."><meta property="og:type" content="article"><meta property="og:url" content="https://dotsplayground.com/2020/03/customnativecontainerpt1/"><meta property="article:published_time" content="2020-03-18T10:59:02+01:00"><meta property="article:modified_time" content="2020-03-18T10:59:02+01:00"><meta itemprop=name content="Custom Native Container [Part 1]: The Basics"><meta itemprop=description content="This article will show how to create a basic custom native container in Unity DOTS for use with the job system."><meta itemprop=datePublished content="2020-03-18T10:59:02+01:00"><meta itemprop=dateModified content="2020-03-18T10:59:02+01:00"><meta itemprop=wordCount content="1352"><meta itemprop=keywords content="dots,ecs,csharp,intermediate,native container,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Custom Native Container [Part 1]: The Basics"><meta name=twitter:description content="This article will show how to create a basic custom native container in Unity DOTS for use with the job system."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head></head><body class=main-center itemscope itemtype=http://schema.org/WebPage><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=slimContent><div class=navbar-header><div class="profile-block text-center"><a id=avatar href=https://github.com/Eothaun/DOTS-Playground/ target=_blank><img class="img-circle img-rotate" src=https://dotsplayground.com/avatar.png width=200 height=200></a><h2 id=name class="hidden-xs hidden-sm">DOTS Playground</h2><h3 id=title class="hidden-xs hidden-sm hidden-md">Year 3 Students Gamedevs</h3><small id=location class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Breda University of Applied Sciences</small></div><div class=search id=search-form-wrap><form class="search-form sidebar-form"><div class=input-group><input type=text class="search-form-input form-control" placeholder=Search>
<span class=input-group-btn><button type=submit class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button></span></div><div class=ins-search><div class=ins-search-mask></div><div class=ins-search-container><div class=ins-input-wrapper><input type=text class=ins-search-input placeholder="Type something..." x-webkit-speech>
<button type=button class="close ins-close ins-selectable" data-dismiss=modal aria-label=Close><span aria-hidden=true>×</span></button></div><div class=ins-section-wrapper><div class=ins-section-container></div></div></div></div></form></div><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#main-navbar aria-controls=main-navbar aria-expanded=false>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><nav id=main-navbar class="collapse navbar-collapse" itemscope itemtype=http://schema.org/SiteNavigationElement role=navigation><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href=/><i class="icon icon-home-fill"></i><span class=menu-title>Home</span></a></li><li class="menu-item menu-item-series"><a href=/series><i class="icon icon-project"></i><span class=menu-title>Series</span></a></li><li class="menu-item menu-item-archives"><a href=/posts><i class="icon icon-archives-fill"></i><span class=menu-title>Archives</span></a></li><li class="menu-item menu-item-categories"><a href=/categories><i class="icon icon-folder"></i><span class=menu-title>Categories</span></a></li><li class="menu-item menu-item-tags"><a href=/tags><i class="icon icon-tags"></i><span class=menu-title>Tags</span></a></li><li class="menu-item menu-item-books"><a href=/research_resources><i class="icon icon-book-fill"></i><span class=menu-title>Dots Resources</span></a></li><li class="menu-item menu-item-about"><a href=/about><i class="icon icon-users"></i><span class=menu-title>About</span></a></li></ul></nav></div></header><aside class=sidebar itemscope itemtype=http://schema.org/WPSideBar><div class=slimContent><div class=widget><h3 class=widget-title>Board</h3><div class=widget-body><div id=board><div class=content><p>Write programs that do one thing and do it well. Write programs to work together — McIlroy Unix philosophy<br><br>Write systems that do one thing and do it well. Write systems to work together — DOD adoption</p></div></div></div></div><div class=widget><h3 class=widget-title>Categories</h3><div class=widget-body><ul class=category-list><li class=category-list-item><a href=https://dotsplayground.com/categories/community/ class=category-list-link>community</a><span class=category-list-count>1</span></li><li class=category-list-item><a href=https://dotsplayground.com/categories/data-oriented-design/ class=category-list-link>data-oriented-design</a><span class=category-list-count>1</span></li><li class=category-list-item><a href=https://dotsplayground.com/categories/dots/ class=category-list-link>dots</a><span class=category-list-count>10</span></li><li class=category-list-item><a href=https://dotsplayground.com/categories/ecs/ class=category-list-link>ecs</a><span class=category-list-count>9</span></li><li class=category-list-item><a href=https://dotsplayground.com/categories/unity/ class=category-list-link>unity</a><span class=category-list-count>10</span></li></ul></div></div><div class=widget><h3 class=widget-title>Tags</h3><div class=widget-body><ul class=tag-list><li class=tag-list-item><a href=https://dotsplayground.com/tags/beginner/ class=tag-list-link>beginner</a><span class=tag-list-count>2</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/community/ class=tag-list-link>community</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/componentdatafromentity/ class=tag-list-link>componentdatafromentity</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/csharp/ class=tag-list-link>csharp</a><span class=tag-list-count>8</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/data-oriented-design/ class=tag-list-link>data-oriented-design</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/dod/ class=tag-list-link>dod</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/dots/ class=tag-list-link>dots</a><span class=tag-list-count>10</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/ecs/ class=tag-list-link>ecs</a><span class=tag-list-count>8</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/education/ class=tag-list-link>education</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/esc/ class=tag-list-link>esc</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/hybrid/ class=tag-list-link>hybrid</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/intermediate/ class=tag-list-link>intermediate</a><span class=tag-list-count>5</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/learning/ class=tag-list-link>learning</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/native-container/ class=tag-list-link>native-container</a><span class=tag-list-count>5</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/physics/ class=tag-list-link>physics</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/reference/ class=tag-list-link>reference</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/relation/ class=tag-list-link>relation</a><span class=tag-list-count>1</span></li><li class=tag-list-item><a href=https://dotsplayground.com/tags/software-engineering/ class=tag-list-link>software-engineering</a><span class=tag-list-count>1</span></li></ul></div></div><div class=widget><h3 class=widget-title>Recent Posts</h3><div class=widget-body><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class=item-inner><p class=item-title><a href=https://dotsplayground.com/2020/04/howtofinddotspackageinformation/ class=title>How to find more information about the DOTS packages?</a></p><p class=item-date><time datetime="2020-04-01 10:59:02 +0100 +0100" itemprop=datePublished>2020-04-01</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://dotsplayground.com/2020/03/customnativecontainerpt5/ class=title>Custom Native Container [Part 5]: ParallelFor Using ParallelWriter With Thread Index</a></p><p class=item-date><time datetime="2020-03-18 11:03:02 +0100 +0100" itemprop=datePublished>2020-03-18</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://dotsplayground.com/2020/03/customnativecontainerpt4/ class=title>Custom Native Container [Part 4]: Parallel Job Using ParallelWriter</a></p><p class=item-date><time datetime="2020-03-18 11:02:02 +0100 +0100" itemprop=datePublished>2020-03-18</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://dotsplayground.com/2020/03/customnativecontainerpt3/ class=title>Custom Native Container [Part 3]: Parallel Job Using Min Max</a></p><p class=item-date><time datetime="2020-03-18 11:01:02 +0100 +0100" itemprop=datePublished>2020-03-18</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://dotsplayground.com/2020/03/customnativecontainerpt2/ class=title>Custom Native Container [Part 2]: Deallocate On Job Completion</a></p><p class=item-date><time datetime="2020-03-18 11:00:02 +0100 +0100" itemprop=datePublished>2020-03-18</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id=collapseToc itemscope itemtype=http://schema.org/WPSideBar><div class=slimContent><nav id=toc class=article-toc><h3 class=toc-title>Catalogue</h3><div class="toc-content always-active"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#nativeintarray>NativeIntArray</a></li><li><a href=#1-member-variables>1) Member Variables</a></li><li><a href=#2-allocating-memory>2) Allocating Memory</a></li><li><a href=#3-readwrite-access>3) Read/Write Access</a></li><li><a href=#4-disposing>4) Disposing</a></li><li><a href=#usage>Usage</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></nav></div></aside><main class=main role=main><div class=content><article id=- class="article article-type-" itemscope itemtype=http://schema.org/BlogPosting><div class=article-header><h1 itemprop=name><a class=article-title href=/2020/03/customnativecontainerpt1/>Custom Native Container [Part 1]: The Basics</a></h1><div class=article-meta><span class=article-date><i class="icon icon-calendar-check"></i><a href=https://dotsplayground.com/2020/03/customnativecontainerpt1/ class=article-date><time datetime="2020-03-18 10:59:02 +0100 +0100" itemprop=datePublished>2020-03-18</time></a>
</span><span class=article-category><i class="icon icon-folder"></i><a class=article-category-link href=/categories/dots/>dots</a>
<a class=article-category-link href=/categories/ecs/>ecs</a>
<a class=article-category-link href=/categories/unity/>unity</a></span>
<span class=article-tag><i class="icon icon-tags"></i><a class=article-tag-link href=/tags/dots/>dots</a>
<a class=article-tag-link href=/tags/ecs/>ecs</a>
<a class=article-tag-link href=/tags/csharp/>csharp</a>
<a class=article-tag-link href=/tags/intermediate/>intermediate</a>
<a class=article-tag-link href=/tags/native-container/>native container</a></span>
<span class="post-wordcount hidden-xs" itemprop=wordCount>Word Count:1352 words</span>
<span class="post-readcount hidden-xs" itemprop=timeRequired>Read Count:7 minutes</span><br>Written by:
<a href=https://github.com/MennoMarkus><i class="icon icon-users"></i>Menno Markus</a></div></div><div class="article-entry marked-body" itemprop=articleBody><h2 id=introduction>Introduction</h2><p>Native containers are used for data communication between jobs. Unity already provides a set of native containers in their <a href=https://docs.unity3d.com/Packages/com.unity.collections@latest/>Collections</a> package, such as NativeList, NativeQueue, NativeHashMap, etc. But when you need something more custom, you can write your own native container.</p><p>In this article we will write such a custom container that can be used with jobs. In subsequent articles we will look into adding more advanced features to this container such as adding support for parallel jobs. These articles will not be about how to write a <em>good</em> container type, but rather will seek to demonstrate all the features that can be implemented when writing a custom native container. This article expects basic knowledge of pointers and memory management.</p><p><a href=https://github.com/Eothaun/DOTS-Playground/commit/5c00dadb86cc68ed76f329f8b8a49a7249cd475d#diff-4107cbc15e6b7565cf1a71565ac1e755>The final result of this article can be found here.</a></p><h2 id=nativeintarray>NativeIntArray</h2><p>The container we will be implementing is called NativeIntArray. It is a fixed size array of integers, essentially the same as <code>NativeArray&lt;int></code>. We will purposely use such a simple example so we can focus on the actual native container implementation. The basic structure of this container is shown below. We will override parts of it to turn into a native container.</p><div class=highlight><div style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#93a1a1;font-style:italic>// We will be working with pointers, so our struct needs to be unsafe.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#859900>public</span> <span style=color:#859900>unsafe</span> <span style=color:#859900>struct</span> <span style=color:#cb4b16>NativeIntArray</span>
{
    <span style=color:#859900>internal</span> <span style=color:#859900>void</span>* <span style=color:#268bd2>m_Buffer</span>; <span style=color:#93a1a1;font-style:italic>// Array to hold our integers.
</span><span style=color:#93a1a1;font-style:italic></span>    <span style=color:#859900>internal</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>m_Length</span>;

    <span style=color:#859900>public</span> <span style=color:#268bd2>NativeIntArray</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>length</span>) { <span style=color:#93a1a1;font-style:italic>/* Allocate memory... */</span> }

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#859900>this</span>[<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>] <span style=color:#93a1a1;font-style:italic>// Getter and setter using NativeIntArray[index].
</span><span style=color:#93a1a1;font-style:italic></span>    {
        <span style=color:#859900>get</span> { <span style=color:#859900>return</span> *((<span style=color:#859900;font-weight:700>int</span>*)<span style=color:#268bd2>m_Buffer</span> + <span style=color:#268bd2>index</span>); }
        <span style=color:#859900>set</span> { *((<span style=color:#859900;font-weight:700>int</span>*)<span style=color:#268bd2>m_Buffer</span> + <span style=color:#268bd2>index</span>) = <span style=color:#859900>value</span>; }
    }

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Increment</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>) { <span style=color:#859900>return</span> ++<span style=color:#859900>this</span>[<span style=color:#268bd2>index</span>]; }

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Decrement</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>) { <span style=color:#859900>return</span> --<span style=color:#859900>this</span>[<span style=color:#268bd2>index</span>]; }

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Add</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>, <span style=color:#859900;font-weight:700>int</span> <span style=color:#859900>value</span>) { <span style=color:#859900>return</span> (<span style=color:#859900>this</span>[<span style=color:#268bd2>index</span>] += <span style=color:#859900>value</span>); } 

	<span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Length</span> =&gt; <span style=color:#268bd2>m_Length</span>;
}
</code></pre></td></tr></table></div></div><h2 id=1-member-variables>1) Member Variables</h2><p>Lets first define all the member variables and some of the attributes to turn our struct into a native container. <strong>The naming and order of variables is very important here!</strong> Make sure to copy it exactly so you do not get weird results. The rest of the code is explained through comments. Do not be afraid if you do not understand what each line does exactly, having a rough idea of what each part does is more important.</p><div class=highlight><div style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#859900>using</span> <span style=color:#268bd2>System</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>System.Diagnostics</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>System.Runtime.InteropServices</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>System.Threading</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Burst</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Collections</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Collections.LowLevel.Unsafe</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Jobs</span>;

<span style=color:#93a1a1;font-style:italic>// Needed to mark as a native container.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#268bd2>[NativeContainer]</span> 
<span style=color:#93a1a1;font-style:italic>// Ensure our memory layout is the same as the order of our variables.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#268bd2>[StructLayout(LayoutKind.Sequential)]</span> 
<span style=color:#859900>public</span> <span style=color:#859900>unsafe</span> <span style=color:#859900>struct</span> <span style=color:#cb4b16>NativeIntArray</span> : <span style=color:#268bd2>IDisposable</span>
{
    <span style=color:#93a1a1;font-style:italic>// Relax the pointer safety so jobs can schedule with this container.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#268bd2>    [NativeDisableUnsafePtrRestriction]</span> <span style=color:#859900>internal</span> <span style=color:#859900>void</span>* <span style=color:#268bd2>m_Buffer</span>;
    <span style=color:#859900>internal</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>m_Length</span>;

    <span style=color:#93a1a1;font-style:italic>// This macro makes sure safety features can be disabled for better performance.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#93a1a1;font-style:italic>#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span><span style=color:#93a1a1;font-style:italic></span>    <span style=color:#93a1a1;font-style:italic>// Handle to tell if operations such as reading and writing can be performed safely.
</span><span style=color:#93a1a1;font-style:italic></span>    <span style=color:#859900>internal</span> <span style=color:#268bd2>AtomicSafetyHandle</span> <span style=color:#268bd2>m_Safety</span>;

    <span style=color:#93a1a1;font-style:italic>// Handle to tell if the container has been disposed.
</span><span style=color:#93a1a1;font-style:italic></span>    <span style=color:#93a1a1;font-style:italic>// This is a managed object. It can be passed along as the job can&#39;t dispose the container, 
</span><span style=color:#93a1a1;font-style:italic></span>    <span style=color:#93a1a1;font-style:italic>// but needs to be (re)set to null on schedule to prevent job access to a managed object.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#268bd2>    [NativeSetClassTypeToNullOnSchedule]</span> <span style=color:#859900>internal</span> <span style=color:#268bd2>DisposeSentinel</span> <span style=color:#268bd2>m_DisposeSentinel</span>;
<span style=color:#93a1a1;font-style:italic>#endif
</span><span style=color:#93a1a1;font-style:italic></span>
    <span style=color:#93a1a1;font-style:italic>// Keep track of which memory was allocated (Allocator.Temp/TempJob/Persistent).
</span><span style=color:#93a1a1;font-style:italic></span>    <span style=color:#859900>internal</span> <span style=color:#268bd2>Allocator</span> <span style=color:#268bd2>m_AllocatorLabel</span>;

	<span style=color:#93a1a1;font-style:italic>/*
</span><span style=color:#93a1a1;font-style:italic>	 * ... Next Code ...
</span><span style=color:#93a1a1;font-style:italic>	 */</span>
</code></pre></td></tr></table></div></div><h2 id=2-allocating-memory>2) Allocating Memory</h2><p>Next we will write out constructor and <code>Allocate</code> function. The constructor will use the <code>Allocate</code> function to allocate memory for our buffer. The code is again explained through added comments.</p><div class=highlight><div style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>	<span style=color:#93a1a1;font-style:italic>/*
</span><span style=color:#93a1a1;font-style:italic>	 * ... Previous Code ...
</span><span style=color:#93a1a1;font-style:italic>	 */</span>

    <span style=color:#859900>public</span> <span style=color:#268bd2>NativeIntArray</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>length</span>, <span style=color:#268bd2>Allocator</span> <span style=color:#268bd2>allocator</span>, <span style=color:#268bd2>NativeArrayOptions</span> <span style=color:#268bd2>options</span> = <span style=color:#268bd2>NativeArrayOptions</span>.<span style=color:#268bd2>ClearMemory</span>)
    {
        <span style=color:#268bd2>Allocate</span>(<span style=color:#268bd2>length</span>, <span style=color:#268bd2>allocator</span>, <span style=color:#859900>out</span> <span style=color:#859900>this</span>);

        <span style=color:#93a1a1;font-style:italic>// Set the memory block to 0 if requested.
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#859900>if</span> ((<span style=color:#268bd2>options</span> &amp; <span style=color:#268bd2>NativeArrayOptions</span>.<span style=color:#268bd2>ClearMemory</span>) == <span style=color:#268bd2>NativeArrayOptions</span>.<span style=color:#268bd2>ClearMemory</span>)
            <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>MemClear</span>(<span style=color:#268bd2>m_Buffer</span>, (<span style=color:#859900;font-weight:700>long</span>)<span style=color:#268bd2>length</span> * <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>SizeOf</span>&lt;<span style=color:#859900;font-weight:700>int</span>&gt;());
    }

    <span style=color:#859900>static</span> <span style=color:#859900>void</span> <span style=color:#268bd2>Allocate</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>length</span>, <span style=color:#268bd2>Allocator</span> <span style=color:#268bd2>allocator</span>, <span style=color:#859900>out</span> <span style=color:#268bd2>NativeIntArray</span> <span style=color:#268bd2>array</span>)
    {
		<span style=color:#93a1a1;font-style:italic>// Calculate how many bytes are needed.
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#859900;font-weight:700>long</span> <span style=color:#268bd2>size</span> = <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>SizeOf</span>&lt;<span style=color:#859900;font-weight:700>int</span>&gt;() * (<span style=color:#859900;font-weight:700>long</span>)<span style=color:#268bd2>length</span>;

        <span style=color:#93a1a1;font-style:italic>// Check if this is a valid allocation.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#93a1a1;font-style:italic>#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#859900>if</span> (<span style=color:#268bd2>allocator</span> &lt;= <span style=color:#268bd2>Allocator</span>.<span style=color:#268bd2>None</span>)
            <span style=color:#859900>throw</span> <span style=color:#859900>new</span> <span style=color:#268bd2>ArgumentException</span>(<span style=color:#2aa198>&#34;Allocator must be Temp, TempJob or Persistent&#34;</span>, <span style=color:#268bd2>nameof</span>(<span style=color:#268bd2>allocator</span>));

        <span style=color:#859900>if</span> (<span style=color:#268bd2>length</span> &lt; <span style=color:#2aa198;font-weight:700>0</span>)
            <span style=color:#859900>throw</span> <span style=color:#859900>new</span> <span style=color:#268bd2>ArgumentOutOfRangeException</span>(<span style=color:#268bd2>nameof</span>(<span style=color:#268bd2>length</span>), <span style=color:#2aa198>&#34;Length must be &gt;= 0&#34;</span>);

        <span style=color:#859900>if</span> (<span style=color:#268bd2>size</span> &gt; <span style=color:#859900;font-weight:700>int</span>.<span style=color:#268bd2>MaxValue</span>)
            <span style=color:#859900>throw</span> <span style=color:#859900>new</span> <span style=color:#268bd2>ArgumentOutOfRangeException</span>(<span style=color:#268bd2>nameof</span>(<span style=color:#268bd2>length</span>), <span style=color:#2aa198>$&#34;Length * sizeof(int) cannot exceed {(object)int.MaxValue} bytes&#34;</span>);

        <span style=color:#93a1a1;font-style:italic>// There are other checks you might want to perform when working with generic containers.
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#93a1a1;font-style:italic>/* 
</span><span style=color:#93a1a1;font-style:italic>        if (!UnsafeUtility.IsBlittable&lt;T&gt;())
</span><span style=color:#93a1a1;font-style:italic>           throw new ArgumentException(string.Format(&#34;{0} used in NativeCustomArray&lt;{0}&gt; must be blittable&#34;, typeof(T)));
</span><span style=color:#93a1a1;font-style:italic>
</span><span style=color:#93a1a1;font-style:italic>        if (!UnsafeUtility.IsValidNativeContainerElementType&lt;T&gt;())
</span><span style=color:#93a1a1;font-style:italic>            throw new InvalidOperationException($&#34;{typeof(T)} used in NativeCustomArray&lt;{typeof(T)}&gt; must be unmanaged (contain no managed types) and cannot itself be a native container type.&#34;);
</span><span style=color:#93a1a1;font-style:italic>        */</span>
<span style=color:#93a1a1;font-style:italic>#endif
</span><span style=color:#93a1a1;font-style:italic></span>
        <span style=color:#268bd2>array</span> = <span style=color:#859900>default</span>(<span style=color:#268bd2>NativeIntArray</span>);
        <span style=color:#93a1a1;font-style:italic>// Allocate memory for our buffer.
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#268bd2>array</span>.<span style=color:#268bd2>m_Buffer</span> = <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>Malloc</span>(<span style=color:#268bd2>size</span>, <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>AlignOf</span>&lt;<span style=color:#859900;font-weight:700>int</span>&gt;(), <span style=color:#268bd2>allocator</span>);
        <span style=color:#268bd2>array</span>.<span style=color:#268bd2>m_Length</span> = <span style=color:#268bd2>length</span>;
        <span style=color:#268bd2>array</span>.<span style=color:#268bd2>m_AllocatorLabel</span> = <span style=color:#268bd2>allocator</span>;

<span style=color:#93a1a1;font-style:italic>#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#93a1a1;font-style:italic>// Create a dispose sentinel to track memory leaks. 
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#93a1a1;font-style:italic>// An atomic safety handle is also created automatically.
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#268bd2>DisposeSentinel</span>.<span style=color:#268bd2>Create</span>(<span style=color:#859900>out</span> <span style=color:#268bd2>array</span>.<span style=color:#268bd2>m_Safety</span>, <span style=color:#859900>out</span> <span style=color:#268bd2>array</span>.<span style=color:#268bd2>m_DisposeSentinel</span>, <span style=color:#2aa198;font-weight:700>1</span>, <span style=color:#268bd2>allocator</span>);
<span style=color:#93a1a1;font-style:italic>#endif
</span><span style=color:#93a1a1;font-style:italic></span>    }

	<span style=color:#93a1a1;font-style:italic>/*
</span><span style=color:#93a1a1;font-style:italic>	 * ... Next Code ...
</span><span style=color:#93a1a1;font-style:italic>	 */</span>
</code></pre></td></tr></table></div></div><h2 id=3-readwrite-access>3) Read/Write Access</h2><p>Now we can finally write the functionality to change values in our array. The code for this is pretty straight forward, if not simpler than the original.</p><div class=highlight><div style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>	<span style=color:#93a1a1;font-style:italic>/*
</span><span style=color:#93a1a1;font-style:italic>	 * ... Previous Code ...
</span><span style=color:#93a1a1;font-style:italic>	 */</span>

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#859900>this</span>[<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>]
    {
        <span style=color:#859900>get</span>
        {
<span style=color:#93a1a1;font-style:italic>#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span><span style=color:#93a1a1;font-style:italic></span>        	<span style=color:#268bd2>AtomicSafetyHandle</span>.<span style=color:#268bd2>CheckReadAndThrow</span>(<span style=color:#268bd2>m_Safety</span>);
<span style=color:#93a1a1;font-style:italic>#endif
</span><span style=color:#93a1a1;font-style:italic></span>            <span style=color:#859900>return</span> <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>ReadArrayElement</span>&lt;<span style=color:#859900;font-weight:700>int</span>&gt;(<span style=color:#268bd2>m_Buffer</span>, <span style=color:#268bd2>index</span>);
        }
<span style=color:#268bd2>
</span><span style=color:#268bd2>        [WriteAccessRequired]</span>
        <span style=color:#859900>set</span>
        {
<span style=color:#93a1a1;font-style:italic>#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span><span style=color:#93a1a1;font-style:italic></span>        	<span style=color:#268bd2>AtomicSafetyHandle</span>.<span style=color:#268bd2>CheckWriteAndThrow</span>(<span style=color:#268bd2>m_Safety</span>);
<span style=color:#93a1a1;font-style:italic>#endif
</span><span style=color:#93a1a1;font-style:italic></span>            <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>WriteArrayElement</span>(<span style=color:#268bd2>m_Buffer</span>, <span style=color:#268bd2>index</span>, <span style=color:#859900>value</span>);
        }
    }

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Increment</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>) { <span style=color:#859900>return</span> ++<span style=color:#859900>this</span>[<span style=color:#268bd2>index</span>]; }

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Decrement</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>) { <span style=color:#859900>return</span> --<span style=color:#859900>this</span>[<span style=color:#268bd2>index</span>]; }

    <span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Add</span>(<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>index</span>, <span style=color:#859900;font-weight:700>int</span> <span style=color:#859900>value</span>) { <span style=color:#859900>return</span> (<span style=color:#859900>this</span>[<span style=color:#268bd2>index</span>] += <span style=color:#859900>value</span>); }

	<span style=color:#859900>public</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>Length</span> =&gt; <span style=color:#268bd2>m_Length</span>;

	<span style=color:#93a1a1;font-style:italic>/*
</span><span style=color:#93a1a1;font-style:italic>	 * ... Next Code ...
</span><span style=color:#93a1a1;font-style:italic>	 */</span>
</code></pre></td></tr></table></div></div><h2 id=4-disposing>4) Disposing</h2><p>There is one last thing we must not forget before we can use our container, and that is <code>Dispose</code>. Dispose can be called to cleanup an free our memory after we are done with our container.</p><div class=highlight><div style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>	<span style=color:#93a1a1;font-style:italic>/*
</span><span style=color:#93a1a1;font-style:italic>	 * ... Previous Code ...
</span><span style=color:#93a1a1;font-style:italic>	 */</span>

	<span style=color:#859900>public</span> <span style=color:#859900>void</span> <span style=color:#268bd2>Dispose</span>()
    {
<span style=color:#93a1a1;font-style:italic>#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#859900>if</span> (!<span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>IsValidAllocator</span>(<span style=color:#268bd2>m_AllocatorLabel</span>))
            <span style=color:#859900>throw</span> <span style=color:#859900>new</span> <span style=color:#268bd2>InvalidOperationException</span>(<span style=color:#2aa198>&#34;The NativeArray can not be Disposed because it was not allocated with a valid allocator.&#34;</span>);

        <span style=color:#268bd2>DisposeSentinel</span>.<span style=color:#268bd2>Dispose</span>(<span style=color:#859900>ref</span> <span style=color:#268bd2>m_Safety</span>, <span style=color:#859900>ref</span> <span style=color:#268bd2>m_DisposeSentinel</span>);
<span style=color:#93a1a1;font-style:italic>#endif
</span><span style=color:#93a1a1;font-style:italic></span>
		<span style=color:#93a1a1;font-style:italic>// Free the allocated memory and reset our variables.
</span><span style=color:#93a1a1;font-style:italic></span>        <span style=color:#268bd2>UnsafeUtility</span>.<span style=color:#268bd2>Free</span>(<span style=color:#268bd2>m_Buffer</span>, <span style=color:#268bd2>m_AllocatorLabel</span>);
        <span style=color:#268bd2>m_Buffer</span> = <span style=color:#859900>null</span>;
        <span style=color:#268bd2>m_Length</span> = <span style=color:#2aa198;font-weight:700>0</span>;
    }
}
</code></pre></td></tr></table></div></div><h2 id=usage>Usage</h2><p>That is it! We now have created a <code>NativeIntArray</code> that can be used with jobs like below.</p><div class=highlight><div style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Burst</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Collections</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Entities</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Jobs</span>;
<span style=color:#859900>using</span> <span style=color:#268bd2>Unity.Mathematics</span>;

<span style=color:#859900>public</span> <span style=color:#859900>class</span> <span style=color:#cb4b16>NativeIntArraySystem</span> : <span style=color:#268bd2>SystemBase</span>
{
	<span style=color:#859900>protected</span> <span style=color:#859900>override</span> <span style=color:#859900>void</span> <span style=color:#268bd2>OnUpdate</span>()
    {
        <span style=color:#268bd2>NativeIntArray</span> <span style=color:#268bd2>myArray</span> = <span style=color:#859900>new</span> <span style=color:#268bd2>NativeIntArray</span>(<span style=color:#2aa198;font-weight:700>1</span><span style=color:#2aa198;font-weight:700>0</span><span style=color:#2aa198;font-weight:700>0</span>, <span style=color:#268bd2>Allocator</span>.<span style=color:#268bd2>TempJob</span>);
		<span style=color:#268bd2>Job</span>.<span style=color:#268bd2>WithName</span>(<span style=color:#2aa198>&#34;NativeIntArrayJob&#34;</span>).<span style=color:#268bd2>WithCode</span>(() =&gt;
        {
            <span style=color:#859900>for</span> (<span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>i</span> = <span style=color:#2aa198;font-weight:700>0</span>; <span style=color:#268bd2>i</span> &lt; <span style=color:#268bd2>myArray</span>.<span style=color:#268bd2>Length</span>; <span style=color:#268bd2>i</span>++)
				<span style=color:#268bd2>myArray</span>.<span style=color:#268bd2>Increment</span>(<span style=color:#268bd2>i</span>);
        }).<span style=color:#268bd2>Run</span>();

        <span style=color:#268bd2>myArray</span>.<span style=color:#268bd2>Dispose</span>();
	}
}
</code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion</h2><p>This article showed all the steps involved to create a bare basic native container. But you might have already noticed that a few very useful features are missing. For instance <code>.WithDeallocateOnJobCompletion</code> and <code>[DeallocateOnJobCompletion]</code> will throw an error that our container does not support this incredibly useful feature. We will implement missing features in the next parts of this series:</p><p>Custom Native Container [Part 1]: The Basics<br><a href=/2020/03/customnativecontainerpt2/>Custom Native Container [Part 2]: Deallocate On Job Completion</a><br><a href=/2020/03/customnativecontainerpt3/>Custom Native Container [Part 3]: Parallel Job Using Min Max</a><br><a href=/2020/03/customnativecontainerpt4/>Custom Native Container [Part 4]: Parallel Job Using ParallelWriter</a><br><a href=/2020/03/customnativecontainerpt5/>Custom Native Container [Part 5]: ParallelFor Using ParallelWriter With Thread Index</a></p></div></article></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class=bar-inner><ul class="pager pull-left"><li class=prev><a href=https://dotsplayground.com/2020/02/dotseditor/ title="Unity DOTS Editor"><i class="icon icon-angle-left" aria-hidden=true></i><span>&nbsp;&nbsp;Older</span></a></li><li class=next><a href=https://dotsplayground.com/2020/03/customnativecontainerpt2/ title="Custom Native Container [Part 2]: Deallocate On Job Completion"><span>Newer&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden=true></i></a></li><li class=toggle-toc><a class="toggle-btn collapsed" data-toggle=collapse href=#collapseToc aria-expanded=false title=Catalogue role=button><span>[&nbsp;</span><span>Catalogue</span>
<i class="text-collapsed icon icon-anchor"></i><i class="text-in icon icon-close"></i><span>]</span></a></li></ul><div class=bar-right><div class=share-component data-sites=facebook,twitter,linkedin data-mobile-sites=facebook,twitter,linkedin></div></div></div></nav></main><footer class=footer itemscope itemtype=http://schema.org/WPFooter><ul class=social-links><li><a href=https://github.com/MarjoleinKaal target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Marjolein</a></li><li><a href=https://github.com/FireFlyForLife target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Maiko</a></li><li><a href=https://github.com/MennoMarkus target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Menno</a></li><li><a href=https://github.com/Nvs2000 target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Niels</a></li><li><a href=https://github.com/jesseroffel target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Jesse</a></li><li><a href=https://github.com/JonahRutten target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Jonah</a></li><li><a href=https://github.com/PepijnAverink target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Pepijn</a></li><li><a href=https://github.com/RobinACS target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Robin</a></li><li><a href=https://github.com/simonrenger target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i>Simon</a></li><li><a href=https://dotsplayground.com/index.xml target=_blank title=rss data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li></ul><div class=copyright>&copy;2019 -
2020<div class=publishby>Theme by <a href=https://github.com/xiaoheiAh target=_blank>xiaoheiAh </a>base on<a href=https://github.com/xiaoheiAh/hugo-theme-pure target=_blank> pure</a>.</div></div></footer><script src=https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/rust.min.js></script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/dockerfile.min.js></script><script></script><script type=text/javascript src=https://dotsplayground.com/js/application.js></script><script type=text/javascript src=https://dotsplayground.com/js/plugin.js></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:'Posts',PAGES:'Pages',CATEGORIES:'Categories',TAGS:'Tags',UNTITLED:'(Untitled)',},ROOT_URL:'https:\/\/dotsplayground.com\/',CONTENT_URL:'https:\/\/dotsplayground.com\/\/searchindex.json ',};window.INSIGHT_CONFIG=INSIGHT_CONFIG;})(window);</script><script type=text/javascript src=https://dotsplayground.com/js/insight.js></script><script type=text/javascript src=https://dotsplayground.com/raphael/raphael.min.js></script><script type=text/javascript src=https://flowchart.js.org/flowchart-latest.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CFEDM0JHBQ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-CFEDM0JHBQ');</script><script>$(".diagram").each((indx,elm)=>{var diagram=flowchart.parse($(elm).text());$(elm).text("");diagram.drawSVG(elm);});</script></body></html>